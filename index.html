<!DOCTYPE html>
<html>
<head>
    <title>Field Data Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
        #map { height: 100vh; width: 100%; }
        
        .dashboard-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            /* --- RESPONSIVE CHANGE --- */
            max-width: 280px; 
            border: 1px solid #ddd;
        }
        .dashboard-panel h3 { margin: 0 0 10px 0; }
        .dashboard-stats p { margin: 5px 0; font-size: 14px; }
        .dashboard-stats strong { color: #333; }
        .dashboard-filters h4 { margin: 15px 0 5px 0; font-size: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .filter-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .filter-buttons button {
            flex-grow: 1;
            padding: 6px 8px;
            font-size: 12px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .filter-buttons button:hover { background-color: #e9e9e9; border-color: #999; }
        .filter-buttons button.active {
            background-color: #8A2BE2; /* Purple */
            color: white;
            border-color: #8A2BE2;
            font-weight: bold;
        }
        #status { font-style: italic; color: #666; font-size: 12px; margin-top: 10px; }

        /* --- NEW: Media Query for Mobile Responsiveness --- */
        @media (max-width: 480px) {
            .dashboard-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                width: auto; /* Let it be flexible */
                max-width: none; /* Override the desktop max-width */
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="dashboard-panel">
        <h3>Dashboard</h3>
        <div class="dashboard-stats">
            <p>Total Points: <strong id="count-total">...</strong></p>
            <p>Today's Points: <strong id="count-today">...</strong></p>
            <p>Last Hour: <strong id="count-hour">...</strong></p>
        </div>
        <div class="dashboard-filters">
            <h4>Filter by Time</h4>
            <div class="filter-buttons">
                <button id="filter-all" class="active">All Time</button>
                <button id="filter-today">Today</button>
                <button id="filter-2days">Last 2 Days</button>
            </div>
        </div>
        <div id="status">Initializing...</div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
</body>
</html>
<script>
    // --- CONFIGURATION ---
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyZjjPHSKNNGJBJudDzshTc1XASWrMtDALSN5kwNOP7edELrv8eqh_r3hBcdCGgYUrFPQ/exec'; // Paste your URL here
    const REFRESH_INTERVAL_MS = 60000;
    const BASE_DOT_COLOR = '#8A2BE2';
    const NEWEST_DOT_COLOR = '#FF00FF';
    const CLUSTER_DISABLE_ZOOM = 12;
    // --- END CONFIGURATION ---

    // --- GLOBAL VARIABLES ---
    let allGeoJsonData = null;
    let pointsLayer = null;
    let countiesLayer = null;
    let activeFilter = 'all';

    const map = L.map('map', { center: [40.0, -96.0], zoom: 4, preferCanvas: true });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, attribution: '© OpenStreetMap, © CARTO'
    }).addTo(map);

    // --- HELPER FUNCTIONS ---
    function lerpColor(a, b, amount) { 
        const ar = a >> 16, ag = a >> 8 & 0xff, ab = a & 0xff,
              br = b >> 16, bg = b >> 8 & 0xff, bb = b & 0xff,
              rr = ar + amount * (br - ar),
              rg = ag + amount * (bg - ag),
              rb = ab + amount * (bb - ab);
        return "#" + ((1 << 24) + (rr << 16) + (rg << 8) + rb | 0).toString(16).slice(1);
    }

    // --- NEW: Custom Date Parser for 'DD/MM/YYYY HH:mm:ss' format ---
    function parseCustomDate(dateString) {
        // Example input: "13/10/2025 09:09:19"
        const parts = dateString.split(' ');
        const dateParts = parts[0].split('/');
        const timeParts = parts[1].split(':');
        
        // new Date(year, monthIndex (0-11), day, hour, minute, second)
        // Note: month is 0-indexed in JS, so we subtract 1
        return new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]);
    }

    // --- DATA FETCHING & PROCESSING ---
    async function fetchData() {
        document.getElementById('status').textContent = 'Fetching new data...';
        try {
            const response = await fetch(WEB_APP_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            // --- DATE PARSING FIX ---
            // Use our custom parser instead of the unreliable new Date()
            data.features.forEach(feature => {
                feature.properties.date = parseCustomDate(feature.properties.timestamp);
            });
            
            data.features.sort((a, b) => a.properties.date - b.properties.date);
            allGeoJsonData = data;
            
            updateDashboardStats();
            updateMap();
            document.getElementById('status').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

        } catch (error) {
            console.error('Failed to fetch map data:', error);
            document.getElementById('status').textContent = 'Error loading data.';
        }
    }

    // --- UI & DASHBOARD UPDATES ---
    function updateDashboardStats() {
        if (!allGeoJsonData) return;
        
        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000));
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        let todayCount = 0;
        let hourCount = 0;

        allGeoJsonData.features.forEach(feature => {
            // Check if the date is valid before comparing
            if (feature.properties.date && !isNaN(feature.properties.date)) {
                if (feature.properties.date >= startOfToday) {
                    todayCount++;
                }
                if (feature.properties.date >= oneHourAgo) {
                    hourCount++;
                }
            }
        });

        document.getElementById('count-total').textContent = allGeoJsonData.features.length;
        document.getElementById('count-today').textContent = todayCount;
        document.getElementById('count-hour').textContent = hourCount;
    }

    // --- MAP RENDERING LOGIC ---
    function updateMap() {
        if (!allGeoJsonData) return;

        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));

        const filteredFeatures = allGeoJsonData.features.filter(feature => {
            if (!feature.properties.date || isNaN(feature.properties.date)) {
                return false; // Exclude invalid dates
            }
            switch (activeFilter) {
                case 'today': return feature.properties.date >= startOfToday;
                case '2days': return feature.properties.date >= twoDaysAgo;
                case 'all': default: return true;
            }
        });
        
        if (pointsLayer) { map.removeLayer(pointsLayer); }

        pointsLayer = L.markerClusterGroup({
            disableClusteringAtZoom: CLUSTER_DISABLE_ZOOM,
            chunkedLoading: true,
            maxClusterRadius: 60,
        });
        
        const minTime = filteredFeatures.length > 0 ? filteredFeatures[0].properties.date.getTime() : now.getTime();
        const maxTime = filteredFeatures.length > 0 ? filteredFeatures[filteredFeatures.length - 1].properties.date.getTime() : now.getTime();
        const timeSpan = maxTime - minTime;

        const geoJsonLayer = L.geoJSON({ type: "FeatureCollection", features: filteredFeatures }, {
            pointToLayer: function (feature, latlng) {
                let color = BASE_DOT_COLOR;
                if (timeSpan > 0) {
                    const featureTime = feature.properties.date.getTime();
                    const ageRatio = (featureTime - minTime) / timeSpan;
                    const baseHex = parseInt(BASE_DOT_COLOR.slice(1), 16);
                    const newHex = parseInt(NEWEST_DOT_COLOR.slice(1), 16);
                    color = lerpColor(baseHex, newHex, ageRatio);
                }
                
                return L.circleMarker(latlng, { radius: 6, stroke: false, fillColor: color, fillOpacity: 0.8 });
            },
            onEachFeature: function (feature, layer) {
                layer.bindPopup(`<b>Timestamp:</b> ${feature.properties.timestamp}`);
            }
        });

        pointsLayer.addLayer(geoJsonLayer);
        map.addLayer(pointsLayer);
    }
    
    // --- LAZY LOADING COUNTIES ---
    function setupLazyCountyLoader() {
        const loadCounties = () => {
            if (map.getZoom() >= 4 && !countiesLayer) {
                map.off('zoomend', loadCounties);
                fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json')
                    .then(response => response.json())
                    .then(countiesData => {
                        countiesLayer = L.geoJSON(countiesData, {
                            style: { color: "#999", weight: 1, opacity: 0.5, fillOpacity: 0 },
                            interactive: false
                        }).addTo(map);
                    })
                    .catch(error => console.error('Could not load county boundaries:', error));
            }
        };
        map.on('zoomend', loadCounties);
        loadCounties();
    }

    // --- EVENT LISTENERS FOR FILTERS ---
    const filterButtons = document.querySelectorAll('.filter-buttons button');
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            activeFilter = button.id.split('-')[1];
            updateMap();
        });
    });

    // --- START THE APPLICATION ---
    fetchData();
    setInterval(fetchData, REFRESH_INTERVAL_MS);
    setupLazyCountyLoader();
</script>
