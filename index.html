<!DOCTYPE html>
<html>
<head>
    <title>Field Data Monitor</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        /* Adjusted info-panel since layer control is moved */
        .info-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <strong>Live Field Map</strong>
        <div id="status">Loading data...</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyZjjPHSKNNGJBJudDzshTc1XASWrMtDALSN5kwNOP7edELrv8eqh_r3hBcdCGgYUrFPQ/exec'; // Paste your URL here
        const REFRESH_INTERVAL_MS = 30000;
        // --- END CONFIGURATION ---

        // --- UPDATED: Define more basemaps ---
        const plain = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
	        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
	        maxZoom: 20
        });

        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	        attribution: 'Tiles &copy; Esri &mdash; i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, and the GIS User Community'
        });
        
        const terrain = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.png', {
	        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	        subdomains: 'abcd',
	        minZoom: 0,
	        maxZoom: 18
        });

        const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        });
        
        // --- UPDATED: Set the default layer to 'plain' ---
        const map = L.map('map', {
            center: [40.7128, -98.0060], // Centered on the US
            zoom: 4,
            layers: [plain] // The default layer is now the plain white map
        });
        
        // --- UPDATED: Create the layer control object and add new maps ---
        const baseMaps = {
            "Plain": plain,
            "Street": osm,
            "Satellite": satellite,
            "Terrain": terrain,
            "Dark Mode": dark
        };

        // --- UPDATED: Add position option to move the control ---
        L.control.layers(baseMaps, null, { position: 'bottomright' }).addTo(map);

        let pointsLayer = null;
        const statusDiv = document.getElementById('status');

        const geoJsonOptions = {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 5,
                    fillColor: "#ff7800",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function (feature, layer) {
                const props = feature.properties;
                layer.bindPopup(`<b>Timestamp:</b> ${props.timestamp}`);
            }
        };

        async function fetchData() {
            try {
                statusDiv.textContent = 'Fetching new data...';
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (pointsLayer) { map.removeLayer(pointsLayer); }

                pointsLayer = L.geoJSON(data, geoJsonOptions).addTo(map);
                
                if (map.getZoom() <= 4 && data.features.length > 0) {
                     map.fitBounds(pointsLayer.getBounds().pad(0.1));
                }
               
                statusDiv.textContent = `Updated: ${new Date().toLocaleTimeString()} (${data.features.length} points)`;
            } catch (error) {
                console.error('Failed to fetch map data:', error);
                statusDiv.textContent = 'Error loading data.';
            }
        }
        
        async function loadCountyBoundaries() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json');
                const countiesData = await response.json();
                
                const countyStyle = { "color": "#888", "weight": 1, "opacity": 0.65, "fillOpacity": 0 };

                L.geoJSON(countiesData, { style: countyStyle }).addTo(map);
            } catch (error) {
                console.error('Could not load county boundaries:', error);
            }
        }

        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL_MS);
        loadCountyBoundaries();
    </script>
</body>
</html>
